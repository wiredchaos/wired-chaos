name: ğŸ¤– Notion AI Bot Command Executor

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Notion AI Bot command to execute'
        required: true
        type: string
      service:
        description: 'Service to deploy (suite/tax/worker)'
        required: false
        type: choice
        options:
          - suite
          - tax
          - worker
          - emergency
        default: 'suite'
      environment:
        description: 'Deployment environment'
        required: false
        type: choice
        options:
          - production
          - staging
        default: 'production'
      skip_tests:
        description: 'Skip smoke tests'
        required: false
        type: boolean
        default: false

jobs:
  execute-notion-command:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Parse Command
        id: parse
        run: |
          echo "Executing Notion command: ${{ github.event.inputs.command }}"
          
          # Extract command action
          COMMAND="${{ github.event.inputs.command }}"
          ACTION=$(echo $COMMAND | cut -d' ' -f1)
          PARAMS=$(echo $COMMAND | cut -d' ' -f2-)
          
          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "params=$PARAMS" >> $GITHUB_OUTPUT
          
          # Set deployment flags
          case "$ACTION" in
            "/deploy")
              echo "is_deployment=true" >> $GITHUB_OUTPUT
              ;;
            "/status")
              echo "is_status=true" >> $GITHUB_OUTPUT
              ;;
            "/generate")
              echo "is_generate=true" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "is_custom=true" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: ğŸš€ Execute Deployment
        if: steps.parse.outputs.is_deployment == 'true'
        uses: ./.github/workflows/notion-deploy.yml
        with:
          service: ${{ github.event.inputs.service }}
          environment: ${{ github.event.inputs.environment }}
          skip_tests: ${{ github.event.inputs.skip_tests }}

      - name: ğŸ“Š Execute Status Check
        if: steps.parse.outputs.is_status == 'true'
        run: |
          echo "ğŸ” Checking system status..."
          
          # Test main endpoints
          curl -f https://www.wiredchaos.xyz/health || echo "âŒ Main API unhealthy"
          curl -f https://wired-chaos.pages.dev/api/health || echo "âŒ Frontend API unhealthy"
          
          # Check recent deployments
          gh api repos/wiredchaos/wired-chaos/actions/runs \
            --jq '.workflow_runs[0:5] | .[] | "\(.conclusion): \(.name) (\(.created_at))"' \
            || echo "âŒ Failed to fetch deployment history"
          
          echo "âœ… Status check completed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ¨ Execute Generation
        if: steps.parse.outputs.is_generate == 'true'
        run: |
          echo "ğŸ¨ Generating content..."
          
          # Parse generation type
          PARAMS="${{ steps.parse.outputs.params }}"
          TYPE=$(echo $PARAMS | cut -d'-' -f1)
          
          case "$TYPE" in
            "suite")
              echo "ğŸ“‹ Generating Suite presentation..."
              echo "âœ… Suite presentation would be created via Gamma API"
              ;;
            "tax")
              echo "ğŸ’° Generating Tax presentation..."
              echo "âœ… Tax presentation would be created via Gamma API"
              ;;
            "swarm")
              echo "ğŸ¤– Generating SWARM status dashboard..."
              echo "âœ… SWARM dashboard would be created via Gamma API"
              ;;
            *)
              echo "â“ Unknown generation type: $TYPE"
              ;;
          esac

      - name: ğŸ“¤ Post Results to Notion
        if: always()
        run: |
          echo "ğŸ“¤ Posting results back to Notion..."
          
          # Create result payload
          RESULT_JSON=$(cat << EOF
          {
            "command": "${{ github.event.inputs.command }}",
            "status": "${{ job.status }}",
            "workflow_run_id": "${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "environment": "${{ github.event.inputs.environment }}",
            "service": "${{ github.event.inputs.service }}"
          }
          EOF
          )
          
          echo "Result payload: $RESULT_JSON"
          
          # In production, this would POST to Notion webhook
          echo "âœ… Results would be posted to Notion via webhook"

  # Deployment sub-workflow
  deploy-service:
    if: contains(github.event.inputs.command, '/deploy')
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Trigger Deployment
        run: |
          echo "ğŸš€ Triggering deployment for: ${{ github.event.inputs.service }}"
          
          # Map services to workflow IDs
          case "${{ github.event.inputs.service }}" in
            "suite")
              WORKFLOW_ID="194153015"
              ;;
            "tax"|"worker")
              WORKFLOW_ID="194323650"
              ;;
            "emergency")
              WORKFLOW_ID="194323651"
              ;;
            *)
              echo "âŒ Unknown service: ${{ github.event.inputs.service }}"
              exit 1
              ;;
          esac
          
          # Trigger the deployment workflow
          gh api repos/wiredchaos/wired-chaos/actions/workflows/$WORKFLOW_ID/dispatches \
            --method POST \
            --field ref=main \
            --field inputs='{"environment":"${{ github.event.inputs.environment }}"}'
          
          echo "âœ… Deployment triggered successfully"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # SWARM Bot trigger
  trigger-swarm:
    if: contains(github.event.inputs.command, 'swarm')
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ¤– Trigger SWARM Bot
        run: |
          echo "ğŸ¤– Triggering SWARM Bot..."
          
          # Trigger SWARM monitoring workflow
          gh workflow run "swarm-bot.yml" || echo "SWARM workflow not found, continuing..."
          
          echo "âœ… SWARM Bot triggered"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Notification job
  notify-completion:
    needs: [execute-notion-command]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¢ Notify Completion
        run: |
          echo "ğŸ‰ Notion AI Bot command execution completed!"
          echo "Command: ${{ github.event.inputs.command }}"
          echo "Status: ${{ needs.execute-notion-command.result }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          
          # Create success/failure badge
          if [[ "${{ needs.execute-notion-command.result }}" == "success" ]]; then
            echo "âœ… COMMAND EXECUTED SUCCESSFULLY"
          else
            echo "âŒ COMMAND EXECUTION FAILED"
          fi

      - name: ğŸ”— Generate Links
        run: |
          echo "ğŸ“Š Workflow Results:"
          echo "â€¢ Workflow: https://github.com/wiredchaos/wired-chaos/actions/runs/${{ github.run_id }}"
          echo "â€¢ Repository: https://github.com/wiredchaos/wired-chaos"
          echo "â€¢ Main Site: https://www.wiredchaos.xyz"
          echo "â€¢ Frontend: https://wired-chaos.pages.dev"